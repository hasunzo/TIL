# 1장 사용자 수에 따른 규모 확장성

## 단일서버
앱, 웹, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행되는 시스템
- 단일서버 시스템에서 사용자의 요청이 처리되는 흐름
1. 사용자는 도메인 이름을 이용하여 웹사이트에 접속한다.
    - DNS(Domain Name Service)에 질의하여 도메인 이름을 IP 주소로 변환하는 작업이 필요하다.
    
2. DNS의 조회 결과로 IP 주소가 반환된다. 이 주소가 웹 서버의 주소이다.
3. 해당 IP주소로 HTTP(HyperText Transfer Protocol) 요청이 전달된다.
4. 요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환한다.

#### 실제 요청은 어디로부터 올까?
- 이러한 요청들은 두 가지 종류의 단말로부터 온다.
1. 웹 애플리케이션
   - 서버 구현용 언어(자바, 파이썬 등) 사용 : 비즈니스 로직, 데이터 저장등을 처리하기 위함
   - 클라이언트 구현용 언어 사용 : 프레젠테이션용
2. 모바일 앱
   - HTTP 프로토콜 이용 : 모바일 앱과 웹 서버 간의 통신을 위함
   - HTTP 프로토콜을 통해서 반환될 응답 데이터의 포맷으로는 보통 간결함의 이유로 JSON 사용
   
## 데이터베이스
사용자가 늘어나면 여러 서버를 두어야 한다.
- 웹/모바일 트래픽 처리 용도
- 데이터베이스용
- 웹 계층과 데이터 계층을 분리하면 각각을 독립적으로 확장해 나갈 수 있다.

#### 어떤 데이터베이스를 사용할 것인가?
- 관계형 데이터베이스 (relational database)
   - RDBMS(Relational Data-base ManagementSystem)
   - MySQL, 오라클 데이터베이스 PostgreSQL
   - 관계형 데이터베이스는 자료를 테이블과 열, 칼럼으로 표현함
   - SQL을 사용하면 여러 테이블에 잇는 데이터를 관계에 따라 조인하여 합칠 수 있다.
- 비-관계형 데이터베이스
   - NoSQL
   - CouchDB, Neo4j, Cassandra, HBase, Amazon DynamoDB
   - 🔎 NoSQL의 네 부류
      - 키-값 저장소
      - 그래프 저장소
      - 칼럼 저장소
      - 문서 저장소
   - 조인 연산은 지원하지 않는다.
   - 🔎 비-관계형 데이터베이스를 쓰는 것이 바람직한 경우
      - 아주 낮은 응답 지연시간이 요구됨
      - 다루는 데이터가 비정형이라 관계형 데이터가 아님
      - 데이터를 직렬화하거나 역직렬화 할 수 있기만 하면 됨
      - 아주 많은 양의 데이터를 저장할 필요가 있음
   

## 수직적 규모 확장 vs 수평적 규모 확장
- 수직적 규모 확장 (vertical scaling) 프로세스
   - 서버에 고사양 자원(더 좋은 CPU, 더 많은 RAM 등)을 추가하는 행위
   - 서버로 유입되는 트래픽의 양이 적을 때 선택
   - 🔎 단점
      - 수직적 규모 확장의 한계 : 한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법이 없다.
      - 서버에 장애가 발생하면 웹사이트/앱 완전히 중단됨 : 자동복구 방안 & 다중화 방안을 제시하지 않기 때문
- 수평적 규모 확장 프로세스
   - 많은 서버를 추가하여 성능을 개선하는 행위
   - 대규모 애플리케이션을 지원하는 데에 선택
   

#### 로드밸런서 (load balancer)
- 단일서버와 같은 설계의 사용자는 웹 서버에 바로 연결된다. 웹 서버가 다운되면 사용자는 웹 서버에 접속할 수 없다.
- 너무 많은 사용자가 접속하여 웹서버가 한계 상황에 도달하게 되면 응답 속도가 느려지고 서버 접속이 불가능해질 수 있다.

💡 이러한 문제를 해결하기 위해서는 로드밸런서를 도입한다.

- 로드밸런서는 부하 분산 집합(load balancing set)에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.
- 로드밸런스의 동작 과정
   - 사용자가 로드밸런서의 공개 IP 주소(public IP address)로 접속
      - 웹 서버가 클라이언트의 접속을 직접 처리하지 않음.
   - 더 나은 보안을 위해, 서버 간 통신에는 사설 IP 주소(private IP address)가 이용됨.
      - 사설 IP 주소는 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 IP주소 -> 인터넷을 통해 접속할 수 없다.
   
- 로드밸런스를 사용함으로써 얻게되는 가용성의 향상
1. 서버 1 다운 > 트래픽 서버 2 전송
   - 웹 사이트 전체가 다운되는 일 방지
   - 부하를 나누기 위해 새로운 서버 추가 가능
   
2. 웹사이트로 유입되는 트래픽이 가파르게 증가하여 트래픽을 감당할 수 없는 시점이 오면,
웹 서버 계층에 더 많은 서버를 추가한다.
   - 로드밸런스는 자동적으로 트래픽을 분산하기 시작한다.
   

#### 데이터베이스 다중화
- 웹 계층은 로드밸런서를 사용하여 해결하면 되고 데이터베이스는 어떻게 해결할까?
   - 데이터베이스 다중화로 해결
   
- 데이터베이스 다중화란?
   - 서버 사이에 주(master)-부(slave) 관계를 설정
   - 주 서버 > 데이터 원본 저장
   - 부 서버 > 데이터 사본 저장
   
- 주 서버
   - 쓰기 연산
   - insert, delete, update
   
- 부 서버
   - 읽기 연산
   - 대부분의 애플리케이션은 쓰기 연산 보다 읽기 연산의 비중이 크다. 따라서 부 데이터베이스의 수가 주 데이터베이스의 수보다 많다.
   
#### 데이터베이스 다중화를 통해 얻게되는 이점
1. 더 나은 성능
   - 모든 데이터 변경 연산은 주 데이터베이스 서버로,
   - 모든 읽기 연산은 부 데이터베이스 서버로 분산
   - 병렬로 처리될 수 있는 질의의 수가 늘어나므로 성능이 좋아진다.
   
2. 안정성
   - 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존된다.
   - 데이터를 지역적으로 떨어진 여러 장소에 다중화시켜 놓을 수 있기 떄문
   
3. 가용성
   - 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생해도 
   다른 서버에 있는 데이터를 가져와 계속 서비스할 수 있게 한다.
     
#### 데이터베이스 버서 가운데 하나가 다운되면 벌어지는 일
🔎 부 데이터베이스 서버가 다운되면?
- 부 서버가 한 대 뿐인 경우
   - 읽기 연산 한시적으로 주 데이터베이스로 전달
   - 새로운 부 데이터베이스 서버가 장애 서버를 대체
   
- 부 서버가 여러 대인 경우
   - 읽기 연산 나머지 부 데이터베이스 서버들로 분산
   - 새로운 부 데이터베이스 서버가 장애 서버를 대체
   
🔎 주 데이터베이스 서버가 다운되면?
- 한 대의 부 데이터베이스만 있는 경우
   - 해당 부 데이터베이스 서버가 새로운 주 서버
   - 모든 데이터베이스연산은 일시적으로 새로운 주 서버상에서 수행
   - 새로운 부서버가 추가
   
#### 로드밸런서와 데이터베이스 다중화를 고려한 설계안의 동작 과정
1. 사용자는 DNS로부터 로드밸런스의 공개 IP 주소를 받는다.
2. 사용자는 해당 IP 주소를 사용해 로드밸런서에 접속한다.
3. HTTP 요청은 서버 1이나 서버 2로 전달
4. 웹 서버는 사용자의 데이터를 부 데이터베이스 서버에서 읽는다.
5. 웹 서버는 데이터 변경 연산은 주 데이터베이스로 전달한다. 
   - 데이터 추가, 삭제, 갱신 연산등
